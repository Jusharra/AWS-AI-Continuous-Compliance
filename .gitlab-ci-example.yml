stages:
  - security
  - import_findings

variables:
  AWS_DEFAULT_REGION: $AWS_REGION

# ------------------------------------------
# 1) SECURITY SCAN STAGE (placeholder)
# ------------------------------------------
security_scans:
  stage: security
  image: alpine:3.20
  script:
    - |
      echo "Running placeholder security scans..."

      # Write minimal valid JSON for SAST
      cat << 'EOF' > gl-sast-report.json
      { "vulnerabilities": [] }
      EOF

      # Write minimal valid JSON for DAST
      cat << 'EOF' > gl-dast-report.json
      { "vulnerabilities": [] }
      EOF
  artifacts:
    paths:
      - gl-sast-report.json
      - gl-dast-report.json
    expire_in: 1 day
  only:
    - main


# ------------------------------------------
# 2) IMPORT FINDINGS INTO AWS SECURITY HUB
# ------------------------------------------
import_findings_to_security_hub:
  stage: import_findings
  image: python:3.11
  needs:
    - security_scans
  variables:
    AWS_DEFAULT_REGION: $AWS_REGION
    AWS_ACCOUNT_ID: $AWS_ACCOUNT_ID
    AWS_ROLE_ARN: $AWS_ROLE_ARN
    AWS_WEB_IDENTITY_TOKEN_FILE: $CI_JOB_JWT
  script:
    - python --version
    - pip install boto3
    - ls -la
    - ls -la scripts || echo "scripts directory not found"
    - cat gl-sast-report.json || echo "no SAST report"
    - cat gl-dast-report.json || echo "no DAST report"
    - python scripts/gitlab_to_asff.py
  only:
    - main

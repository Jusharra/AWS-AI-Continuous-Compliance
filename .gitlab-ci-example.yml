stages:
  - security
  - import_findings

variables:
  AWS_DEFAULT_REGION: $AWS_REGION

security_scans:
  stage: security
  image: alpine:3.20
  script:
    - echo "Running placeholder security scans..."
    - touch gl-sast-report.json
    - touch gl-dast-report.json
  artifacts:
    paths:
      - gl-sast-report.json
      - gl-dast-report.json
    expire_in: 1 day
  only:
    - main

import_findings_to_security_hub:
  stage: import_findings
  image: python:3.11
  needs:
    - job: security_scans
  variables:
    AWS_DEFAULT_REGION: $AWS_REGION
    AWS_ACCOUNT_ID: $AWS_ACCOUNT_ID
    AWS_ROLE_ARN: $AWS_ROLE_ARN
    AWS_WEB_IDENTITY_TOKEN_FILE: $CI_JOB_JWT_FILE
  script:
    - python --version
    - pip install boto3
    - ls -la
    - ls -la scripts || echo "scripts directory not found"
    - cat gl-sast-report.json || echo "no SAST report"
    - cat gl-dast-report.json || echo "no DAST report"
    - python scripts/gitlab_to_asff.py
  only:
    - main

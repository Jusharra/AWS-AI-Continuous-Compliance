stages:
  - security
  - import_findings

variables:
  AWS_DEFAULT_REGION: $AWS_REGION

# ------------------------------------------
# 1) SECURITY STAGE: REAL SAST + DAST PLACEHOLDER
# ------------------------------------------
security_scans:
  stage: security
  image: python:3.11
  script:
    # Install Bandit for Python SAST
    - pip install bandit
    # Run SAST against your src/ tree
    - bandit -r src -f json -o bandit-report.json || true

    # Convert Bandit JSON -> GitLab-style SAST report gl-sast-report.json
    - python - << 'EOF'
      import json, pathlib

      src = pathlib.Path("bandit-report.json")
      if not src.exists() or not src.read_text().strip():
          data = {"vulnerabilities": []}
      else:
          raw = json.loads(src.read_text())
          vulns = []
          for issue in raw.get("results", []):
              vulns.append({
                  "id": issue.get("test_id"),
                  "name": issue.get("test_name"),
                  "description": issue.get("issue_text"),
                  "severity": issue.get("issue_severity", "Info").title(),
                  "location": {
                      "file": issue.get("filename"),
                      "line": issue.get("line_number"),
                  },
                  "solution": issue.get("test_id"),
              })
          data = {"vulnerabilities": vulns}

      pathlib.Path("gl-sast-report.json").write_text(json.dumps(data))

      # DAST placeholder â€“ will be replaced by real ZAP scan
      pathlib.Path("gl-dast-report.json").write_text('{"vulnerabilities": []}')
      EOF
  artifacts:
    paths:
      - gl-sast-report.json
      - gl-dast-report.json
    expire_in: 1 day
  only:
    - main

# ------------------------------------------
# 2) IMPORT FINDINGS INTO AWS SECURITY HUB
# ------------------------------------------
import_findings_to_security_hub:
  stage: import_findings
  image: python:3.11
  needs:
    - job: security_scans
  variables:
    AWS_DEFAULT_REGION: $AWS_REGION
    AWS_ACCOUNT_ID: $AWS_ACCOUNT_ID
    AWS_ROLE_ARN: $AWS_ROLE_ARN
    AWS_WEB_IDENTITY_TOKEN_FILE: $CI_JOB_JWT
  script:
    - python --version
    - pip install boto3
    - ls -la
    - ls -la scripts || echo "scripts directory not found"
    - cat gl-sast-report.json || echo "no SAST report"
    - cat gl-dast-report.json || echo "no DAST report"
    - python scripts/gitlab_to_asff.py
  only:
    - main
